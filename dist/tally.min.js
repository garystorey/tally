/*! Tally - v0.5.0 - 2013-05-30
* Copyright (c) 2013 Gary Storey; Licensed MIT */
(function(t){"use strict";var s=function(s,i){this.debug=!1,this.$el=s?s:t("textarea"),this.init(i)};s.prototype={init:function(t){return this._setOptions(t),this.$el.data("Tally",this),this._events="focusin.tally focusout.tally keyup.tally keydown.tally input.tally paste.tally",this._initialized=!1,this._buildTallyObject(),this._bindEvents(),this.$el},_setOptions:function(s){var i=this.$el.data("tally");this.options=t.extend(!0,{},t.fn.tally.defaults,s),i&&(this.options=t.extend(!0,{},this.options,i)),this.options.textfield.maxlength=this.$el.attr("maxlength")?this.$el.attr("maxlength"):this.options.textfield.maxlength},_bindEvents:function(){var t=this,s=t.options,i=t.$tally,e=t._events;this.$el.on(e,function(e){switch(e.type){case"focusin":i.addClass(s.tallyClass).css({position:"absolute",zIndex:s.zIndex}).show().text(t._buildText()),t._setXY();break;case"focusout":i.removeClass(s.tallyClass).css({position:"static",zIndex:"auto"}).hide().text("");break;default:i.text(t._buildText())}})},_updateClasses:function(t){this.options.textfield.warnAt>=t?this.$el.hasClass(this.options.textfield.warningClass)||(this.$el.addClass(this.options.textfield.warningClass),this.$tally.addClass(this.options.warningClass),this.$el.trigger("tallyWarning")):this.$el.hasClass(this.options.textfield.warningClass)&&(this.$el.removeClass(this.options.textfield.warningClass),this.$tally.removeClass(this.options.warningClass),this.$el.trigger("tallyPass"))},_buildText:function(){var t=this.options.tallyPattern,s=this._countWords();return t.replace("{{c}}",this._countChars()).replace("{{m}}",this.options.textfield.maxlength).replace("{{w}}",s).replace("{{p}}",this._getPercentage(s,this.options.textfield.maxlength))},_countChars:function(){var t=this.options.textfield.maxlength-this.$el.val().length;return this._updateClasses(t),t},_getPercentage:function(t,s){return 100-parseInt(Math.floor(100*(t/s)),10)},_countWords:function(){var t=this.$el.val();return t.match(/\S+/g)?t.match(/\S+/g).length:0},_buildTallyObject:function(){var s=this.options,i=t("#"+s.tallyID);this._initialized||0!==i.length?this.$tally=i:(this.$tally=t("<div/>",{id:s.tallyID}).hide().appendTo("body"),this._initialized=!0)},destroy:function(){this._initialized&&(this.$tally.remove(),this.$tally=void 0,this.$el.off(".tally"))},_setXY:function(){var t=0,s=0,i=this.options.position.x,e=this.options.position.y,l=parseInt(this.options.position.offsetX,10),a=parseInt(this.options.position.offsetY,10),n=this.$el.offset().left,o=this.$el.width(),h=this.$el.offset().top,r=this.$el.height(),f=this.$tally.outerWidth(),c=this.$tally.outerHeight();switch(i){case"left":t=n;break;case"center":t=n+o/2-f/2;break;case"right":t=n+o-f+6;break;default:t=parseInt(i,10)}switch(e){case"top":s=h-c-8;break;case"center":s=h+r/2-c/2;break;case"bottom":s=h+r+7;break;default:s=parseInt(e,10)}"left"===i&&"center"===e&&(t-=f+13),"right"===i&&"center"===e&&(t+=f+12),"number"==typeof l&&(t+=parseInt(l,10)),"number"==typeof a&&(s+=parseInt(a,10)),this.$tally.css({top:s,left:t})}},jQuery.fn.tally=function(i){if("string"!=typeof i)return this.each(function(){var e=new s(t(this),i);e.init()});if(s=t(this).data("Tally"),null!==s)switch(i){case"init":s.init();break;case"destroy":s.destroy()}},jQuery.fn.tally.defaults={tallyID:"tallyID",tallyClass:"tally",tallyPattern:"{{c}}/{{m}}",warningClass:"warningClass",zIndex:100,textfield:{warnAt:10,maxlength:256,warningClass:"txtWarningClass"},position:{x:"right",y:"bottom",offsetX:0,offsetY:0}}})(jQuery);