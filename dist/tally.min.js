/*! Tally - v0.5.0 - 2013-06-03
* Copyright (c) 2013 Gary Storey; Licensed MIT */
(function(t){"use strict";var s=function(s,i){this.debug=!1,this.el=s,this.$el=t(s),this.init(i)};s.prototype={init:function(t){return this._setOptions(t),this.$el.data("Tally",this),this._events="focusin.tally focusout.tally keyup.tally keydown.tally input.tally paste.tally",this._initialized=!1,this._buildTallyObject(),this._bindEvents(),this.$el},_setOptions:function(s){var i=this.$el.data("tally");this.options=t.extend(!0,{},t.fn.tally.defaults,s),i&&(this.options=t.extend(!0,{},this.options,i)),this.options.textfield.maxlength=this.$el.attr("maxlength")?this.$el.attr("maxlength"):this.options.textfield.maxlength},_bindEvents:function(){var t=this,s=t.options,i=t._events;t.$el.on(i,function(i){switch(i.type){case"focusin":t.$tally.addClass(s.tallyClass).css({position:"absolute",zIndex:s.zIndex}).show().find(".tallyText").text(t._buildText()),t._setXY();break;case"focusout":t.$tally.removeClass(s.tallyClass).removeClass(s.warningClass).css({position:"static",zIndex:"auto"}).hide().find(".tallyText").text("");break;default:t.$tally.find(".tallyText").text(t._buildText())}t._updateClasses(i.target)})},_updateClasses:function(s){this.options.textfield.warnAt>=this._countChars()?this.$tally.hasClass(this.options.warningClass)||(t(s).addClass(this.options.textfield.warningClass),this.$tally.addClass(this.options.warningClass),this.$el.trigger("tallyWarning")):this.$tally.hasClass(this.options.warningClass)&&(t(s).removeClass(this.options.textfield.warningClass),this.$tally.removeClass(this.options.warningClass),this.$el.trigger("tallyPass"))},_buildText:function(){var t=this.options.tallyPattern,s=this._countWords(),i=this._pad(this._countChars());return t.replace("{{c}}",i).replace("{{m}}",this.options.textfield.maxlength).replace("{{w}}",s).replace("{{p}}",this._getPercentage(i,this.options.textfield.maxlength))},_countChars:function(){return this.options.textfield.maxlength-this.$el.val().length},_getPercentage:function(t,s){return 100-parseInt(Math.floor(100*(t/s)),10)},_countWords:function(){var t=this.$el.val();return t.match(/\S+/g)?t.match(/\S+/g).length:t?1:0},_buildTallyObject:function(){var s,i,e=this.options,a=t("#"+e.tallyID);this._initialized||0!==a.length?this.$tally=a:(s=t("<div/>",{id:e.tallyID}).hide(),i=t("<span/>",{"class":e.progressBarClass}),i.appendTo(s),i=t("<span/>",{"class":"tallyText"}).appendTo(s),s.appendTo("body"),this._initialized=!0)},destroy:function(){this._initialized&&(this.$tally.remove(),this.$tally=void 0,this.$el.off(".tally"))},_setXY:function(){var t=0,s=0,i=this.options.position.x,e=this.options.position.y,a=parseInt(this.options.position.offsetX,10),l=parseInt(this.options.position.offsetY,10),n=this.$el.offset().left,o=this.$el.width(),h=this.$el.offset().top,r=this.$el.height(),p=this.$tally.outerWidth(),f=this.$tally.outerHeight();switch(i){case"left":t=n;break;case"center":t=n+o/2-p/2;break;case"right":t=n+o-p+6;break;default:t=parseInt(i,10)}switch(e){case"top":s=h-f-8;break;case"center":s=h+r/2-f/2;break;case"bottom":s=h+r+7;break;default:s=parseInt(e,10)}"left"===i&&"center"===e&&(t-=p+13),"right"===i&&"center"===e&&(t+=p+12),"number"==typeof a&&(t+=parseInt(a,10)),"number"==typeof l&&(s+=parseInt(l,10)),this.$tally.css({top:s,left:t})},_pad:function(t){var s=this.options.textfield.maxlength;for(s=s.length,t+="";s>t.length;)t="0"+t;return t}},jQuery.fn.tally=function(i){if("string"!=typeof i)return this.each(function(){var e=new s(t(this),i);e.init()});if(s=t(this).data("Tally"),null!==s)switch(i){case"init":s.init();break;case"destroy":s.destroy()}},jQuery.fn.tally.defaults={tallyID:"tallyID",tallyClass:"tally",tallyPattern:"{{c}}/{{m}}",warningClass:"warningClass",zIndex:100,textfield:{warnAt:10,maxlength:256,warningClass:"txtWarningClass"},position:{x:"right",y:"bottom",offsetX:0,offsetY:0}}})(jQuery);